<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Game</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; }
        
        /* --- POLISHED MAIN MENU --- */
        #mainMenu { 
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: radial-gradient(circle at center, #2c3e50 0%, #0a0e14 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
            overflow: hidden;
        }
        
        /* Drifting Stars Background */
        #mainMenu::before {
            content: ''; position: absolute; top: 0; left: 0; width: 200vw; height: 200vh;
            background: transparent url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="1.5" fill="white" opacity="0.3"/></svg>') repeat 0 0;
            background-size: 80px 80px; animation: drift 50s linear infinite; z-index: -1;
        }
        @keyframes drift { from { transform: translate(0, 0); } to { transform: translate(-50vw, -50vh); } }
        
        /* Glass Card */
        #menuCard {
            background: rgba(15, 20, 30, 0.7); padding: 40px; border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(255,255,255,0.05);
            text-align: center; backdrop-filter: blur(10px); width: 320px;
        }
        
        #mainMenu h1 { 
            font-size: 48px; margin-top: 0; margin-bottom: 35px; 
            color: #ff4757; text-transform: uppercase; letter-spacing: 5px;
            text-shadow: 0 0 15px rgba(255, 71, 87, 0.6); 
        }

        /* Inputs & Buttons */
        #usernameInput { 
            padding: 15px; font-size: 18px; border-radius: 8px; border: 2px solid #2f3640; 
            margin-bottom: 20px; text-align: center; width: 100%; box-sizing: border-box; outline: none; 
            background: rgba(0, 0, 0, 0.5); color: white; transition: 0.3s; font-weight: bold;
        }
        #usernameInput:focus { border-color: #2ed573; box-shadow: 0 0 10px rgba(46, 213, 115, 0.3); }
        
        .btn { border: none; padding: 12px; font-size: 16px; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.2s; width: 100%; box-sizing: border-box; text-transform: uppercase; letter-spacing: 1px;}
        #joinButton { background: #2ed573; color: #111; font-size: 20px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 15px rgba(46, 213, 115, 0.4); }
        #joinButton:hover { background: #26b963; transform: translateY(-2px); }
        
        .row-buttons { display: flex; gap: 10px; }
        #settingsBtn { background: #3498db; color: white; flex: 1; }
        #settingsBtn:hover { background: #2980b9; }
        #quitBtn { background: #e74c3c; color: white; flex: 1; }
        #quitBtn:hover { background: #c0392b; }

        #errorMsg { color: #ff4757; font-weight: bold; margin-top: 15px; display: none; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; }

        /* Settings Modal */
        #settingsModal { display: none; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 150; align-items: center; justify-content: center; }
        .modal-content { background: #2c3e50; padding: 30px; border-radius: 15px; border: 2px solid #3498db; width: 300px; text-align: center; }
        .modal-content h2 { margin-top: 0; color: #3498db; }
        .close-modal { background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px;}

        /* Quit Screen */
        #quitScreen { display: none; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 300; flex-direction: column; align-items: center; justify-content: center; color: white;}

        /* --- REST OF THE GAME STYLES --- */
        canvas { display: none; }
        #ui { display: none; position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; border: 2px solid #333; z-index: 10; min-width: 200px; }
        #startButton { background: #ff4757; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-weight: bold; margin-top: 10px; width: 100%;}
        #startButton:hover { background: #ff6b81; }
        h2, h3 { margin-top: 0; margin-bottom: 10px;}
        #timerText { font-family: monospace; font-size: 24px; color: #f1c40f; }

        #shopUI { display: none; position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 10px; border: 2px solid #f1c40f; z-index: 10; width: 220px; text-align: center; max-height: 80vh; overflow-y: auto;}
        .gem-text { color: #2ed573; font-size: 24px; font-weight: bold; margin: 5px 0 15px 0; }
        .shop-btn { background: #34495e; color: white; border: 2px solid #3498db; padding: 8px; cursor: pointer; border-radius: 5px; font-size: 13px; font-weight: bold; width: 100%; transition: 0.2s; margin-bottom: 8px;}
        .shop-btn:hover { background: #2980b9; }
        .shop-btn:disabled { background: #7f8c8d; border-color: #95a5a6; cursor: not-allowed; }
        .shop-title { color: #f1c40f; font-size: 14px; margin-bottom: 2px; }

        #taskUI { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #34495e; padding: 30px; border-radius: 15px; border: 4px solid #f1c40f; z-index: 50; width: 450px; text-align: center; box-shadow: 0px 0px 50px rgba(0,0,0,0.8); }
        #taskTitle { font-size: 28px; margin-bottom: 5px; color: #f1c40f; }
        #taskInstruction { font-size: 16px; margin-bottom: 15px; color: #ecf0f1; }
        #taskProgress { font-size: 20px; margin-bottom: 15px; font-weight: bold; color: #2ed573; }
        #minigameArea { position: relative; width: 100%; height: 200px; background: #2c3e50; border: 2px solid #1abc9c; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        #targetHitbox { position: absolute; width: 60px; height: 60px; background: #e74c3c; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; color: white; border: 3px solid #c0392b; transition: top 0.1s, left 0.1s; }
        #closeTaskButton { background: #c0392b; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; font-weight: bold; width: 100%; }
        
        #shopMsg { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 5px; font-size: 18px; font-weight: bold; display: none; z-index: 60;}

        #gameOverScreen { display: none; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.95); z-index: 200; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        #gameOverTitle { font-size: 80px; margin: 0; text-transform: uppercase; text-shadow: 0 0 20px currentColor; }
        #gameOverSub { font-size: 20px; color: #bdc3c7; margin-top: 15px; margin-bottom: 40px; max-width: 800px; line-height: 1.5; }
        #playAgainBtn { background: #3498db; color: white; border: none; padding: 15px 40px; font-size: 24px; cursor: pointer; border-radius: 10px; font-weight: bold; transition: 0.2s; z-index: 201; }
    </style>
</head>
<body>
    
    <div id="mainMenu">
        <div id="menuCard">
            <h1>IMPOSTER</h1>
            
            <input type="text" id="usernameInput" placeholder="Enter your name" maxlength="12" autocomplete="off">
            <button id="joinButton" class="btn" onclick="joinServer()">Join Game</button>
            
            <div class="row-buttons">
                <button id="settingsBtn" class="btn" onclick="document.getElementById('settingsModal').style.display='flex'">Settings</button>
                <button id="quitBtn" class="btn" onclick="document.getElementById('quitScreen').style.display='flex'">Quit</button>
            </div>
            <p id="errorMsg"></p> 
        </div>
    </div>

    <div id="settingsModal">
        <div class="modal-content">
            <h2>Settings</h2>
            <div style="text-align: left; margin-bottom: 15px;">
                <label style="color: white; font-weight: bold;">Master Volume</label><br>
                <input type="range" min="1" max="100" value="50" style="width: 100%; margin-top: 10px;">
            </div>
            <button class="close-modal" onclick="document.getElementById('settingsModal').style.display='none'">Save & Close</button>
        </div>
    </div>

    <div id="quitScreen">
        <h1 style="color: #e74c3c;">Game Closed</h1>
        <p style="color: #bdc3c7; font-size: 20px;">You can safely close this browser tab.</p>
        <button class="btn" style="background: #3498db; width: 200px; margin-top: 20px;" onclick="location.reload()">Return to Menu</button>
    </div>

    <div id="ui">
        <h2>Imposter Game</h2>
        <h3 id="timerText">Time: 5:00</h3>
        <h3 id="roleText" style="color: #a4b0be;">Waiting for game...</h3>
        <p><b>WASD</b> to move.</p>
        <p><b>SPACE</b> to tag/vent/spectate.</p>
        <button id="startButton" onclick="startGame()">Start Game</button>
    </div>

    <div id="shopUI">
        <h2 style="color: #f1c40f; margin:0; font-size: 20px;">ITEM SHOP</h2>
        <div class="gem-text">üíé <span id="gemCount">0</span></div>
        <button id="btnSpeed" class="shop-btn" onclick="buyItem('speed')"><div class="shop-title">üèÉ Speed Boost</div>30 üíé | 2x Speed (30s)</button>
        <button id="btnZoom" class="shop-btn" onclick="buyItem('zoom')"><div class="shop-title">ü¶Ö Eagle Eye</div>40 üíé | Zoom Out (20s)</button>
        <button id="btnWarp" class="shop-btn" onclick="buyItem('warp')"><div class="shop-title">üõ∏ Cafe Warp</div>50 üíé | Instant Teleport</button>
        <button id="btnAuto" class="shop-btn" onclick="buyItem('auto')"><div class="shop-title">‚ö° Auto-Tasker</div>60 üíé | Instantly finishes 1 task</button>
        <button id="btnRadar" class="shop-btn" onclick="buyItem('radar')"><div class="shop-title">üì° Radar Ping</div>80 üíé | See players (5s)</button>
    </div>

    <div id="shopMsg"></div>

    <div id="taskUI">
        <h2 id="taskTitle">Task Name</h2>
        <p id="taskInstruction">Catch the moving target to complete the task!</p>
        <div id="taskProgress">Progress: 0 / 5</div>
        <div id="minigameArea"><div id="targetHitbox" onclick="advanceTask()">Click!</div></div>
        <button id="closeTaskButton" onclick="closeTaskUI()">Cancel / Run Away</button>
    </div>

    <div id="gameOverScreen">
        <h1 id="gameOverTitle">GAME OVER</h1>
        <p id="gameOverSub">The results are in...</p>
        <button id="playAgainBtn" onclick="resetToLobby()">Back to Lobby</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const socket = io();

        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();

        const players = {};
        let myId = null;
        let spectatingId = null; 

        // Economy & State
        let myGems = 100; 
        let activePowerups = { speed: false, zoom: false, autoTask: false, radar: false };
        let speedMultiplier = 1;
        let cameraZoom = 1.0;
        let amIHiding = false; 
        let amIVenting = false; 
        let currentVentIndex = -1;

        let activeTasks = [];
        let currentOpenTaskIndex = -1;
        let currentTaskClicksDone = 0;

        // --- MAP TASKS ---
        const allMapTasks = [
            { id: 1, type: 'ui', name: "Clean Whiteboard", x: 600, y: -1350, instruction: "Scrub the moving dirt spots!", steps: 5, actionText: "Scrub!" },
            { id: 2, type: 'ui', name: "Grade Papers at Ms. Piro's Desk", x: 1600, y: -1300, instruction: "Stamp the bouncing A+ grades!", steps: 4, actionText: "Grade" },
            { id: 3, type: 'ui', name: "Wipe Cafeteria Tables", x: 750, y: -100, instruction: "Wipe up the spilled milk drops!", steps: 4, actionText: "Wipe" },
            { id: 4, type: 'ui', name: "Organize Books in Library", x: 850, y: 800, instruction: "Catch the falling books to sort them!", steps: 6, actionText: "Sort" },
            { id: 5, type: 'ui', name: "Fix Gym Bleachers", x: -1800, y: 0, instruction: "Hammer the loose nails back in!", steps: 5, actionText: "Hammer" },
            { id: 6, type: 'world', name: "Sweep Main Hallway", x: -200, y: 0, tool: 'broom', dirtPiles: [ { x: -250, y: -50, swept: 0, max: 4 }, { x: -150, y: 30, swept: 0, max: 4 }, { x: -220, y: 100, swept: 0, max: 4 }, { x: -100, y: -80, swept: 0, max: 4 } ] },
            { id: 7, type: 'ui', name: "Mix Chemicals", x: -1400, y: 2000, instruction: "Catch the unstable chemical drops!", steps: 6, actionText: "Catch" },
            { id: 8, type: 'ui', name: "Reboot Servers", x: 1400, y: 2000, instruction: "Click the nodes to reconnect the server!", steps: 5, actionText: "Ping Node" },
            { id: 9, type: 'ui', name: "Hack Principal's PC", x: -200, y: 3500, instruction: "Bypass the firewall quickly!", steps: 5, actionText: "Hack" }
        ];

        const lockers = [ {x: -300, y: -900, w: 80, h: 100}, {x: -150, y: -900, w: 80, h: 100}, {x: 800, y: -400, w: 80, h: 100}, {x: -1600, y: 2100, w: 80, h: 100} ];
        const vents = [ {x: -150, y: -300, w: 60, h: 60}, {x: 600, y: 200, w: 60, h: 60}, {x: -1400, y: 1600, w: 60, h: 60}, {x: -400, y: 3650, w: 60, h: 60} ];

        const zones = [
            {x: -500, y: -1500, w: 600, h: 4500, color: '#ecf0f1', pattern: 'tile'}, {x: -1950, y: -1500, w: 1450, h: 3000, color: '#e1b12c', pattern: 'wood'},
            {x: -1950, y: 1500, w: 1450, h: 1500, color: '#95a5a6', pattern: 'tile'}, {x: 100, y: -1500, w: 1850, h: 1000, color: '#78e08f', pattern: 'solid'},
            {x: 100, y: -500, w: 1850, h: 1000, color: '#82ccdd', pattern: 'tile'}, {x: 100, y: 500, w: 1850, h: 1000, color: '#f8a5c2', pattern: 'solid'},
            {x: 100, y: 1500, w: 1850, h: 1500, color: '#34495e', pattern: 'solid'}, {x: -500, y: 3000, w: 600, h: 800, color: '#c0392b', pattern: 'wood'}
        ];

        const labels = [
            {text: "GYM", x: -1200, y: 0, font: "bold 100px Arial", color: "rgba(0,0,0,0.15)"}, {text: "SCIENCE LAB", x: -1200, y: 2250, font: "bold 80px Arial", color: "rgba(0,0,0,0.15)"},
            {text: "MAIN HALLWAY", x: -200, y: -800, font: "bold 60px Arial", color: "rgba(0,0,0,0.15)"}, {text: "MS. PIRO'S CLASSROOM", x: 1000, y: -1000, font: "bold 70px Arial", color: "rgba(0,0,0,0.15)"},
            {text: "CAFETERIA", x: 1000, y: 0, font: "bold 80px Arial", color: "rgba(0,0,0,0.15)"}, {text: "LIBRARY", x: 1000, y: 1000, font: "bold 80px Arial", color: "rgba(0,0,0,0.15)"},
            {text: "COMPUTER ROOM", x: 1000, y: 2250, font: "bold 80px Arial", color: "rgba(255,255,255,0.05)"}, {text: "Ms. Piro's Desk", x: 1600, y: -1325, font: "bold 26px Arial", color: "white"},
            {text: "PRINCIPAL'S OFFICE", x: -200, y: 3400, font: "bold 40px Arial", color: "rgba(0,0,0,0.2)"}
        ];

        const wallColor = '#2c3e50'; 
        const obstacles = [
            {x: -2000, y: -1550, w: 4000, h: 50, color: wallColor}, {x: -2000, y: 3000, w: 1500, h: 50, color: wallColor}, {x: 100, y: 3000, w: 1900, h: 50, color: wallColor}, 
            {x: -2000, y: -1500, w: 50, h: 4500, color: wallColor}, {x: 1950, y: -1500, w: 50, h: 4500, color: wallColor},  
            {x: -550, y: 3000, w: 50, h: 850, color: wallColor}, {x: 100, y: 3000, w: 50, h: 850, color: wallColor}, {x: -550, y: 3800, w: 700, h: 50, color: wallColor}, 
            {x: -500, y: -1500, w: 50, h: 1200, color: wallColor}, {x: -500, y: 300, w: 50, h: 1200, color: wallColor}, {x: -1950, y: 1450, w: 1450, h: 50, color: wallColor}, 
            {x: -500, y: 1800, w: 50, h: 1200, color: wallColor}, {x: 100, y: -1500, w: 50, h: 800, color: wallColor}, {x: 100, y: -500, w: 50, h: 400, color: wallColor},   
            {x: 100, y: 200, w: 50, h: 400, color: wallColor}, {x: 100, y: 900, w: 50, h: 600, color: wallColor}, {x: 100, y: 1800, w: 50, h: 1200, color: wallColor}, 
            {x: 150, y: -500, w: 1800, h: 50, color: wallColor}, {x: 150, y: 500, w: 1800, h: 50, color: wallColor}, {x: 150, y: 1450, w: 1800, h: 50, color: wallColor}, 
            {x: 1400, y: -1400, w: 400, h: 150, color: '#8B4513'}, {x: 200, y: -1450, w: 800, h: 20, color: '#ffffff'},   
            {x: 400, y: -1100, w: 120, h: 80, color: '#D2B48C'}, {x: 700, y: -1100, w: 120, h: 80, color: '#D2B48C'}, {x: 1000, y: -1100, w: 120, h: 80, color: '#D2B48C'}, {x: 1300, y: -1100, w: 120, h: 80, color: '#D2B48C'},
            {x: 400, y: -900, w: 120, h: 80, color: '#D2B48C'}, {x: 700, y: -900, w: 120, h: 80, color: '#D2B48C'}, {x: 1000, y: -900, w: 120, h: 80, color: '#D2B48C'}, {x: 1300, y: -900, w: 120, h: 80, color: '#D2B48C'},
            {x: 400, y: -300, w: 400, h: 150, color: '#bdc3c7'}, {x: 1100, y: -300, w: 400, h: 150, color: '#bdc3c7'}, {x: 1600, y: -400, w: 150, h: 800, color: '#95a5a6'}, 
            {x: 400, y: 700, w: 80, h: 600, color: '#5C4033'}, {x: 700, y: 700, w: 80, h: 600, color: '#5C4033'}, {x: 1000, y: 700, w: 80, h: 600, color: '#5C4033'},
            {x: -1950, y: -1000, w: 200, h: 2000, color: '#7f8c8d'}, {x: -1250, y: -1400, w: 150, h: 30, color: '#c0392b'}, {x: -1250, y: 1370, w: 150, h: 30, color: '#c0392b'},
            {x: -1600, y: 1800, w: 300, h: 100, color: '#2f3640'}, {x: -1000, y: 1800, w: 300, h: 100, color: '#2f3640'}, {x: -1600, y: 2200, w: 300, h: 100, color: '#2f3640'}, {x: -1000, y: 2200, w: 300, h: 100, color: '#2f3640'},
            {x: 300, y: 1800, w: 800, h: 100, color: '#7f8fa6'}, {x: 300, y: 2200, w: 800, h: 100, color: '#7f8fa6'}, {x: 1400, y: 1700, w: 200, h: 600, color: '#192a56'},
            {x: -350, y: 3500, w: 300, h: 100, color: '#8e44ad'}, {x: -250, y: 3650, w: 100, h: 80, color: '#1e272e'}, {x: -480, y: 3100, w: 80, h: 150, color: '#7f8c8d'}, {x: -480, y: 3270, w: 80, h: 150, color: '#7f8c8d'}, {x: 30, y: 3100, w: 50, h: 50, color: '#3498db'}, {x: -450, y: 3700, w: 60, h: 60, color: '#27ae60'}, {x: 0, y: 3700, w: 60, h: 60, color: '#27ae60'}
        ];

        // --- Input Setup ---
        const keys = { w: false, a: false, s: false, d: false };
        window.addEventListener('keydown', (e) => { 
            const key = e.key.toLowerCase(); if(keys.hasOwnProperty(key)) keys[key] = true; 
            const me = players[myId];
            if(e.code === 'Space') {
                if (amIVenting) { currentVentIndex = (currentVentIndex + 1) % vents.length; let vent = vents[currentVentIndex]; me.x = vent.x + vent.w/2; me.y = vent.y + vent.h/2; socket.emit('playerMovement', { x: me.x, y: me.y, isHiding: true }); }
                else if (me && me.isAlive && currentOpenTaskIndex === -1 && !amIHiding && !amIVenting) { socket.emit('tryTag'); }
                else if (me && !me.isAlive) { cycleSpectator(); }
            }
            if(key === 'f' && me && me.isAlive && me.role !== 'imposter' && currentOpenTaskIndex === -1) {
                if (amIHiding) { amIHiding = false; me.isHiding = false; socket.emit('playerMovement', { x: me.x, y: me.y, isHiding: false }); } 
                else { for (let locker of lockers) { if (Math.hypot(me.x - (locker.x + locker.w/2), me.y - (locker.y + locker.h/2)) < 100) { amIHiding = true; me.isHiding = true; me.x = locker.x + locker.w/2; me.y = locker.y + locker.h/2; socket.emit('playerMovement', { x: me.x, y: me.y, isHiding: true }); break; } } }
            }
            if(key === 'v' && me && me.isAlive && me.role === 'imposter') {
                if (amIVenting) { amIVenting = false; me.isHiding = false; socket.emit('playerMovement', { x: me.x, y: me.y, isHiding: false }); } 
                else { for (let i = 0; i < vents.length; i++) { let vent = vents[i]; if (Math.hypot(me.x - (vent.x + vent.w/2), me.y - (vent.y + vent.h/2)) < 80) { amIVenting = true; me.isHiding = true; currentVentIndex = i; me.x = vent.x + vent.w/2; me.y = vent.y + vent.h/2; socket.emit('playerMovement', { x: me.x, y: me.y, isHiding: true }); break; } } }
            }
            if(key === 'e' && me && me.isAlive && !amIHiding && !amIVenting && currentOpenTaskIndex === -1 && document.getElementById('gameOverScreen').style.display !== 'flex') {
                let interactedWithWorldTask = false;
                for (let i = 0; i < activeTasks.length; i++) {
                    let task = activeTasks[i];
                    if (task.type === 'world' && Math.hypot(me.x - task.x, me.y - task.y) < 200) {
                        let sweptPile = false; for (let pile of task.dirtPiles) { if (pile.swept < pile.max && Math.hypot(me.x - pile.x, me.y - pile.y) < 50) { pile.swept++; sweptPile = true; break; } }
                        if (sweptPile) { interactedWithWorldTask = true; let allClean = task.dirtPiles.every(p => p.swept >= p.max); if (allClean) { activeTasks.splice(i, 1); updateGems(20); showMessage("Hallway is Spotless!", "#2ed573"); } break; }
                    }
                }
                if (!interactedWithWorldTask) { for (let i = 0; i < activeTasks.length; i++) { let task = activeTasks[i]; if (task.type === 'ui' && Math.hypot(me.x - task.x, me.y - task.y) < 80) { openTaskUI(i); break; } } }
            }
        });
        window.addEventListener('keyup', (e) => { if(keys.hasOwnProperty(e.key.toLowerCase())) keys[e.key.toLowerCase()] = false; });

        // --- SHOP & MINIGAME ---
        function showMessage(text, color) { const msgEl = document.getElementById('shopMsg'); msgEl.innerText = text; msgEl.style.color = color; msgEl.style.display = 'block'; setTimeout(() => { msgEl.style.display = 'none'; }, 3000); }
        function updateGems(amount) { myGems += amount; document.getElementById('gemCount').innerText = myGems; }
        function buyItem(itemType) {
            const me = players[myId]; if (!me || !me.isAlive) return; const prices = { speed: 30, zoom: 40, warp: 50, auto: 60, radar: 80 };
            if (activePowerups[itemType] && itemType !== 'warp') { showMessage("Powerup already active!", "#e74c3c"); return; }
            if (myGems >= prices[itemType]) {
                updateGems(-prices[itemType]); activePowerups[itemType] = true;
                if (itemType === 'speed') { speedMultiplier = 2; document.getElementById('btnSpeed').disabled = true; showMessage("Speed Boost Activated!", "#2ed573"); setTimeout(() => { activePowerups.speed = false; speedMultiplier = 1; document.getElementById('btnSpeed').disabled = false; }, 30000); } 
                else if (itemType === 'zoom') { cameraZoom = 0.5; document.getElementById('btnZoom').disabled = true; showMessage("Eagle Eye Activated!", "#3498db"); setTimeout(() => { activePowerups.zoom = false; cameraZoom = 1.0; document.getElementById('btnZoom').disabled = false; }, 20000); }
                else if (itemType === 'warp') { me.x = 1000; me.y = 0; socket.emit('playerMovement', { x: me.x, y: me.y }); showMessage("Warped to Cafeteria!", "#9b59b6"); activePowerups.warp = false; }
                else if (itemType === 'auto') { document.getElementById('btnAuto').disabled = true; showMessage("Auto-Tasker Ready! Click a task.", "#f1c40f"); }
                else if (itemType === 'radar') { document.getElementById('btnRadar').disabled = true; showMessage("Radar Ping Active!", "#e74c3c"); setTimeout(() => { activePowerups.radar = false; document.getElementById('btnRadar').disabled = false; }, 5000); }
            } else { showMessage("Not enough gems!", "#e74c3c"); }
        }
        function moveHitbox() { document.getElementById('targetHitbox').style.left = Math.floor(Math.random() * (390 - 60)) + 'px'; document.getElementById('targetHitbox').style.top = Math.floor(Math.random() * (200 - 60)) + 'px'; }
        function openTaskUI(index) { currentOpenTaskIndex = index; currentTaskClicksDone = 0; const task = activeTasks[index]; document.getElementById('taskTitle').innerText = task.name; document.getElementById('taskInstruction').innerText = task.instruction; document.getElementById('targetHitbox').innerText = task.actionText; if (activePowerups.auto) { currentTaskClicksDone = task.steps - 1; activePowerups.auto = false; document.getElementById('btnAuto').disabled = false; document.getElementById('taskInstruction').innerText = "‚ö° AUTO-TASKER APPLIED!"; document.getElementById('taskInstruction').style.color = "#f1c40f"; } else { document.getElementById('taskInstruction').style.color = "#ecf0f1"; } updateTaskProgressUI(); moveHitbox(); document.getElementById('taskUI').style.display = 'block'; keys.w = keys.a = keys.s = keys.d = false; }
        function advanceTask() { if (currentOpenTaskIndex === -1) return; const task = activeTasks[currentOpenTaskIndex]; currentTaskClicksDone++; updateTaskProgressUI(); moveHitbox(); if (currentTaskClicksDone >= task.steps) { activeTasks.splice(currentOpenTaskIndex, 1); updateGems(15); closeTaskUI(); } }
        function updateTaskProgressUI() { if (currentOpenTaskIndex === -1) return; document.getElementById('taskProgress').innerText = `Progress: ${currentTaskClicksDone} / ${activeTasks[currentOpenTaskIndex].steps}`; }
        function closeTaskUI() { currentOpenTaskIndex = -1; document.getElementById('taskUI').style.display = 'none'; }

        // --- GAME OVER ---
        function triggerConfetti() { const colors = ['#f1c40f', '#e74c3c', '#3498db', '#2ed573', '#9b59b6']; const screen = document.getElementById('gameOverScreen'); for(let i=0; i<150; i++) { let c = document.createElement('div'); c.className = 'confetti-particle'; c.style.left = Math.random() * 100 + 'vw'; c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; c.style.animationDuration = (Math.random() * 3 + 2) + 's'; c.style.animationDelay = (Math.random() * 2) + 's'; screen.appendChild(c); setTimeout(() => { if(c.parentNode) c.remove(); }, 6000); } }
        function resetToLobby() { document.getElementById('gameOverScreen').style.display = 'none'; document.getElementById('startButton').style.display = 'block'; document.getElementById('startButton').innerText = "Play Again"; document.querySelectorAll('.confetti-particle').forEach(e => e.remove()); }

        // --- Networking ---
        function cycleSpectator() { const playerIds = Object.keys(players); if (playerIds.length === 0) return; let currentIndex = playerIds.indexOf(spectatingId); currentIndex = (currentIndex + 1) % playerIds.length; spectatingId = playerIds[currentIndex]; }
        
        function joinServer() { 
            const username = document.getElementById('usernameInput').value.trim(); 
            socket.emit('joinGame', username); 
            // Hide menu and show game
            document.getElementById('mainMenu').style.display = 'none'; 
            document.getElementById('ui').style.display = 'block'; 
            canvas.style.display = 'block'; 
        }
        
        function startGame() { socket.emit('startGame'); document.getElementById('startButton').style.display = 'none'; }

        socket.on('connect', () => { myId = socket.id; spectatingId = myId; });
        socket.on('gameStarted', (serverPlayers) => { Object.assign(players, serverPlayers); spectatingId = myId; amIHiding = false; amIVenting = false; document.getElementById('startButton').style.display = 'none'; document.getElementById('gameOverScreen').style.display = 'none'; closeTaskUI(); document.getElementById('gemCount').innerText = myGems; const me = players[myId]; const roleEl = document.getElementById('roleText'); if (me.role === 'imposter') { roleEl.innerText = "Game Started! YOU ARE AN IMPOSTER"; roleEl.style.color = "#ff4757"; activeTasks = []; document.getElementById('shopUI').style.display = 'none'; } else { roleEl.innerText = "Game Started! YOU ARE A CREWMATE"; roleEl.style.color = "#2ed573"; activeTasks = JSON.parse(JSON.stringify(allMapTasks)); document.getElementById('shopUI').style.display = 'block'; } });
        socket.on('playerTagged', (id) => { if (players[id]) players[id].isAlive = false; if (id === myId) { document.getElementById('roleText').innerText = "YOU DIED! Spectating..."; document.getElementById('roleText').style.color = "#a4b0be"; document.getElementById('shopUI').style.display = 'none'; amIHiding = false; amIVenting = false; closeTaskUI(); } });
        socket.on('currentPlayers', (serverPlayers) => { Object.assign(players, serverPlayers); }); 
        socket.on('newPlayer', (player) => { players[player.id] = player; }); 
        socket.on('playerMoved', (player) => { if (players[player.id]) { players[player.id].x = player.x; players[player.id].y = player.y; if(player.hasOwnProperty('isHiding')) players[player.id].isHiding = player.isHiding; } });
        socket.on('timeUpdate', (time) => { let m = Math.floor(time/60); let s = time%60; document.getElementById('timerText').innerText = `Time: ${m}:${s<10?'0'+s:s}`; });
        socket.on('gameOver', (reason) => { document.getElementById('roleText').innerText = "Game Ended"; document.getElementById('shopUI').style.display = 'none'; closeTaskUI(); amIHiding = false; amIVenting = false; const winScreen = document.getElementById('gameOverScreen'); const winTitle = document.getElementById('gameOverTitle'); const winSub = document.getElementById('gameOverSub'); let imposterNames = []; let crewmateNames = []; for (let id in players) { if (players[id].role === 'imposter') imposterNames.push(players[id].name); else crewmateNames.push(players[id].name); } const me = players[myId]; if (reason.includes("Imposter")) { winTitle.innerText = "IMPOSTERS WIN"; winTitle.style.color = "#ff4757"; winSub.innerHTML = `The Imposters have eliminated the crew.<br><br><strong style='color:#ff4757'>Imposters:</strong> ${imposterNames.join(" & ")}`; if (me.role === 'imposter') triggerConfetti(); } else { winTitle.innerText = "CREWMATES WIN"; winTitle.style.color = "#2ed573"; winSub.innerHTML = `The crew survived or finished their tasks!<br><br><strong style='color:#2ed573'>Surviving Crew:</strong> ${crewmateNames.join(", ")}`; if (me.role !== 'imposter') triggerConfetti(); } winScreen.style.display = 'flex'; });
        socket.on('playerDisconnected', (id) => { delete players[id]; if (spectatingId === id) spectatingId = myId; });
        socket.on('joinError', (msg) => { document.getElementById('mainMenu').style.display = 'flex'; document.getElementById('ui').style.display = 'none'; canvas.style.display = 'none'; document.getElementById('errorMsg').innerText = msg; document.getElementById('errorMsg').style.display = 'block'; });

        // --- Physics & Drawing ---
        function checkCollision(circleX, circleY) { const radius = 20; for (let obs of obstacles) { let closestX = Math.max(obs.x, Math.min(circleX, obs.x + obs.w)); let closestY = Math.max(obs.y, Math.min(circleY, obs.y + obs.h)); let distanceX = circleX - closestX; let distanceY = circleY - closestY; if ((distanceX * distanceX + distanceY * distanceY) < (radius * radius)) return true; } return false; }

        function update() {
            if (!myId || !players[myId] || !players[myId].isAlive) return;
            if (currentOpenTaskIndex !== -1 || amIHiding || amIVenting) return; 
            const me = players[myId]; const speed = 5 * speedMultiplier; let nextX = me.x; let nextY = me.y; let moved = false;
            if (keys.w) nextY -= speed; if (keys.s) nextY += speed; if (keys.a) nextX -= speed; if (keys.d) nextX += speed;
            if (nextX !== me.x && !checkCollision(nextX, me.y)) { me.x = nextX; moved = true; }
            if (nextY !== me.y && !checkCollision(me.x, nextY)) { me.y = nextY; moved = true; }
            if (moved) socket.emit('playerMovement', { x: me.x, y: me.y, isHiding: false });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!myId || !players[myId]) { requestAnimationFrame(draw); return; }
            if (!players[spectatingId]) spectatingId = myId;

            const camTarget = players[spectatingId]; const cameraX = camTarget.x - canvas.width / 2; const cameraY = camTarget.y - canvas.height / 2; const me = players[myId];
            ctx.save();
            if (activePowerups.zoom) { ctx.translate(canvas.width / 2, canvas.height / 2); ctx.scale(cameraZoom, cameraZoom); ctx.translate(-canvas.width / 2, -canvas.height / 2); }

            for (let z of zones) { ctx.fillStyle = z.color; ctx.fillRect(z.x - cameraX, z.y - cameraY, z.w, z.h); ctx.strokeStyle = 'rgba(0,0,0,0.05)'; ctx.lineWidth = 2; if (z.pattern === 'tile') { for(let i=0; i<z.w; i+=50) { ctx.beginPath(); ctx.moveTo(z.x + i - cameraX, z.y - cameraY); ctx.lineTo(z.x + i - cameraX, z.y + z.h - cameraY); ctx.stroke(); } for(let i=0; i<z.h; i+=50) { ctx.beginPath(); ctx.moveTo(z.x - cameraX, z.y + i - cameraY); ctx.lineTo(z.x + z.w - cameraX, z.y + i - cameraY); ctx.stroke(); } } else if (z.pattern === 'wood') { for(let i=0; i<z.w; i+=30) { ctx.beginPath(); ctx.moveTo(z.x + i - cameraX, z.y - cameraY); ctx.lineTo(z.x + i - cameraX, z.y + z.h - cameraY); ctx.stroke(); } } }

            let promptMessage = ""; let holdingBroom = false;
            if (me.isAlive && me.role !== 'imposter' && !amIHiding) { for (let task of activeTasks) { if (task.type === 'world') { if (Math.hypot(me.x - task.x, me.y - task.y) < 200) { holdingBroom = true; promptMessage = "Stand on Dirt & Press [E] to Sweep!"; } for (let pile of task.dirtPiles) { if (pile.swept < pile.max) { const dirtX = pile.x - cameraX; const dirtY = pile.y - cameraY; ctx.fillStyle = `rgba(101, 67, 33, ${1 - (pile.swept / pile.max)})`; ctx.beginPath(); ctx.arc(dirtX, dirtY, 20 - (pile.swept * 3), 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = `rgba(60, 40, 20, ${1 - (pile.swept / pile.max)})`; ctx.fillRect(dirtX - 5, dirtY - 5, 3, 3); ctx.fillRect(dirtX + 8, dirtY + 2, 4, 4); ctx.fillRect(dirtX - 2, dirtY + 8, 3, 3); } } } } }

            for (let vent of vents) { const vx = vent.x - cameraX; const vy = vent.y - cameraY; ctx.fillStyle = '#7f8c8d'; ctx.fillRect(vx, vy, vent.w, vent.h); ctx.strokeStyle = '#34495e'; ctx.lineWidth = 4; ctx.strokeRect(vx, vy, vent.w, vent.h); ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 3; for(let v = 10; v < vent.w; v += 10) { ctx.beginPath(); ctx.moveTo(vx + v, vy); ctx.lineTo(vx + v, vy + vent.h); ctx.stroke(); } if (me.isAlive && me.role === 'imposter' && !amIVenting && Math.hypot(me.x - (vent.x + vent.w/2), me.y - (vent.y + vent.h/2)) < 80) { promptMessage = "Press [V] to Enter Vent"; } }
            for (let locker of lockers) { const lx = locker.x - cameraX; const ly = locker.y - cameraY; ctx.fillStyle = '#1e272e'; ctx.fillRect(lx, ly, locker.w, locker.h); ctx.strokeStyle = '#485460'; ctx.lineWidth = 2; ctx.strokeRect(lx + 5, ly + 5, locker.w - 10, locker.h - 10); ctx.fillStyle = '#000'; for(let v = 0; v < 4; v++) { ctx.fillRect(lx + 15, ly + 15 + (v * 8), locker.w - 30, 4); } if (me.isAlive && me.role !== 'imposter' && !amIHiding && Math.hypot(me.x - (locker.x + locker.w/2), me.y - (locker.y + locker.h/2)) < 100) { promptMessage = "Press [F] to Hide in Locker"; } }

            ctx.shadowColor = 'rgba(0, 0, 0, 0.6)'; ctx.shadowBlur = 15; ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5;
            for (let obs of obstacles) { ctx.fillStyle = obs.color; ctx.fillRect(obs.x - cameraX, obs.y - cameraY, obs.w, obs.h); ctx.strokeStyle = 'rgba(0,0,0,0.4)'; ctx.lineWidth = 3; ctx.strokeRect(obs.x - cameraX, obs.y - cameraY, obs.w, obs.h); }
            ctx.shadowColor = 'transparent'; 

            for (let l of labels) { ctx.fillStyle = l.color; ctx.font = l.font; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(l.text, l.x - cameraX, l.y - cameraY); }

            if (me.isAlive && me.role !== 'imposter' && currentOpenTaskIndex === -1 && !amIHiding) { for (let task of activeTasks) { if (task.type === 'ui') { const screenX = task.x - cameraX; const screenY = task.y - cameraY; ctx.shadowColor = '#f1c40f'; ctx.shadowBlur = 20; ctx.fillStyle = 'rgba(241, 196, 15, 0.4)'; ctx.beginPath(); ctx.arc(screenX, screenY, 40, 0, Math.PI * 2); ctx.fill(); ctx.shadowColor = 'transparent'; ctx.strokeStyle = '#f1c40f'; ctx.lineWidth = 4; ctx.stroke(); ctx.fillStyle = 'white'; ctx.font = 'bold 12px Arial'; ctx.fillText("TASK", screenX, screenY); if (Math.hypot(me.x - task.x, me.y - task.y) < 80) promptMessage = `Press [E] to ${task.name}`; } } }
            if (activePowerups.radar && me.isAlive) { for (let id in players) { if (id !== myId && players[id].isAlive) { ctx.beginPath(); ctx.moveTo(me.x - cameraX, me.y - cameraY); ctx.lineTo(players[id].x - cameraX, players[id].y - cameraY); ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)'; ctx.lineWidth = 3; ctx.setLineDash([10, 10]); ctx.stroke(); ctx.setLineDash([]); } } }

            for (let id in players) {
                const p = players[id]; const screenX = p.x - cameraX; const screenY = p.y - cameraY; const isPlayerHiding = (id === myId) ? (amIHiding || amIVenting) : p.isHiding;
                if (isPlayerHiding) { ctx.fillStyle = (p.role === 'imposter') ? '#ff4757' : '#f1c40f'; ctx.beginPath(); ctx.arc(screenX - 5, screenY, 3, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(screenX + 5, screenY, 3, 0, Math.PI * 2); ctx.fill(); } 
                else {
                    ctx.globalAlpha = p.isAlive ? 1.0 : 0.3; 
                    ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(screenX, screenY, 20, 0, Math.PI * 2); ctx.fill();
                    ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.stroke();
                    ctx.fillStyle = '#000000'; ctx.fillRect(screenX - 14, screenY - 8, 10, 8); ctx.fillRect(screenX + 4, screenY - 8, 10, 8); ctx.fillRect(screenX - 4, screenY - 6, 8, 3);   
                    if (id === myId && holdingBroom && p.isAlive) { ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 5; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(screenX + 15, screenY); ctx.lineTo(screenX + 35, screenY + 30); ctx.stroke(); ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.moveTo(screenX + 30, screenY + 25); ctx.lineTo(screenX + 45, screenY + 40); ctx.lineTo(screenX + 25, screenY + 40); ctx.fill(); }
                    ctx.fillStyle = 'white'; ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; let label = p.name; if (id === myId) label = p.role === 'imposter' ? p.name + " (Imposter)" : p.name + " (You)"; else if (!p.isAlive) label = p.name + " (Ghost)"; ctx.fillText(label, screenX, screenY - 30);
                }
            }
            ctx.globalAlpha = 1.0; ctx.restore(); 

            if (promptMessage !== "" && document.getElementById('gameOverScreen').style.display !== 'flex') { ctx.fillStyle = 'rgba(0, 0, 0, 0.8)'; ctx.fillRect(canvas.width / 2 - 250, canvas.height - 120, 500, 60); ctx.fillStyle = '#f1c40f'; ctx.font = 'bold 22px Arial'; ctx.textAlign = 'center'; ctx.fillText(promptMessage, canvas.width / 2, canvas.height - 85); }
            if (amIHiding || amIVenting) { ctx.fillStyle = 'rgba(0, 0, 0, 0.6)'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#fff'; ctx.font = 'bold 24px Arial'; ctx.textAlign = 'center'; if (amIHiding) ctx.fillText(`You are hiding! Press [F] to step out.`, canvas.width / 2, canvas.height - 150); if (amIVenting) { ctx.fillText(`You are in the Vents!`, canvas.width / 2, canvas.height - 170); ctx.fillStyle = '#bdc3c7'; ctx.font = '20px Arial'; ctx.fillText(`Press [Space] to travel ‚Ä¢ Press [V] to exit`, canvas.width / 2, canvas.height - 140); } }
            if (!me.isAlive && document.getElementById('gameOverScreen').style.display !== 'flex') { ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(canvas.width / 2 - 200, canvas.height - 80, 400, 60); ctx.fillStyle = 'white'; ctx.font = 'bold 20px Arial'; ctx.textAlign = 'center'; if (spectatingId === myId) ctx.fillText(`Spectating: Yourself (Ghost)`, canvas.width / 2, canvas.height - 55); else ctx.fillText(`Spectating: ${players[spectatingId].name}`, canvas.width / 2, canvas.height - 55); ctx.font = '14px Arial'; ctx.fillStyle = '#a4b0be'; ctx.fillText(`Press SPACE to switch players`, canvas.width / 2, canvas.height - 35); }
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        loop();
    </script>
</body>
</html>